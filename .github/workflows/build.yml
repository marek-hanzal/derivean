# @format

name: Build

on:
    push:
        branches:
            - main

concurrency:
    group: ${{ github.ref }}
    cancel-in-progress: true

jobs:
    install:
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest
            - name: cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      **/node_modules
                  key: ${{ runner.os }}-install-${{ hashFiles('bun.lock', 'package.json') }}

            - name: install
              run: |
                  bun install

    typecheck:
        runs-on: ubuntu-22.04
        needs:
            - install
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest
            - name: cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      **/node_modules
                  key: ${{ runner.os }}-install-${{ hashFiles('bun.lock', 'package.json') }}

            - name: typecheck
              run: |
                  bun run typecheck

    build:
        runs-on: ubuntu-22.04
        needs:
            - typecheck
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest
            - name: cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      **/node_modules
                  key: ${{ runner.os }}-install-${{ hashFiles('bun.lock', 'package.json') }}

            - name: build
              run: |
                  bun run build
