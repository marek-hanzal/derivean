# @format

name: Build

on:
    push:
        branches:
            - main

concurrency:
    group: ${{ github.ref }}
    cancel-in-progress: true

jobs:
    #
    # Install base packages needed to run library build (Rust stuff)
    #
    # Also ensure lib (Rust) stuff is compiled
    #
    install:
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Install wasm-pack
              uses: jetli/wasm-pack-action@v0.4.0
              with:
                  version: "latest"
            - name: cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      **/node_modules
                  key: ${{ runner.os }}-install-${{ hashFiles('bun.lock', 'package.json') }}

            - name: install
              run: |
                  # Initial dependency installation
                  bun install
                  # Compile Rust stuff
                  bun run lib
                  # Ensure Rust libraries are installed
                  bun install

    typecheck:
        runs-on: ubuntu-22.04
        needs:
            - install
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest
            - name: cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      **/node_modules
                  key: ${{ runner.os }}-install-${{ hashFiles('bun.lock', 'package.json') }}

            - name: typecheck
              run: |
                  bun run typecheck

    build:
        runs-on: ubuntu-22.04
        needs:
            - typecheck
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest
            - name: cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      **/node_modules
                  key: ${{ runner.os }}-install-${{ hashFiles('bun.lock', 'package.json') }}

            - name: build
              run: |
                  bun run build
